# Library Component Specification

**Route:** `/library`
**Conceptual pillar:** Library = Sources (immutable evidence)
**References:**
- [11_CONCEPTUAL_FRAMEWORK.md](../11_CONCEPTUAL_FRAMEWORK.md)
- [11_REDESIGN_ARCH.md](../11_REDESIGN_ARCH.md)
- [01_LIBRARY.md](../01_LIBRARY.md)

## 1. Component Overview
The **Library** (currently implemented as `Recordings`) is the central repository for captured knowledge. Today it focuses on audio captures (currently: recordings from local + device) and their processing state. In the redesign, the Library evolves into the Sources panel + reader experience for all Source types.

Migration pointer (non-normative): current route implementation is `apps/electron/src/pages/Recordings.tsx` (candidate rename: `Library.tsx`).

### 1.1 Invariants (must hold as we evolve)
- Sources are immutable evidence; edits are annotations/notes, not destructive edits.
- Anything generated by AI that the user can act on must be traceable back to Source anchors.
- Long-running work (download, transcription, extraction) is queued and reported via progress; UI stays responsive.

### 1.2 Tri-Pane Layout alignment (Notebook workspace)

Per [11_REDESIGN_ARCH.md](../11_REDESIGN_ARCH.md), the target UI is a tri-pane notebook workspace:

```
┌── Source Panel (Library) ─┬── Knowledge Canvas ─────────┬── Assistant / Tools ───┐
│ Sources tree + filters    │ Source reader / transcript  │ Context-aware chat     │
│ Status (processing/index) │ Notes / highlights / cards  │ Quick actions + graph  │
└───────────────────────────┴─────────────────────────────┴────────────────────────┘
```

How the Library fits:
- **Left pane (Source Panel):** the Library list/tree, filters, and processing states.
- **Center pane (Knowledge Canvas):** when a Source is selected, the reader experience lives here (transcript/PDF/markdown) with stable anchors.
- **Right pane (Assistant/Tools):** the Assistant runs alongside reading/thinking, scoped to the active Notebook + selected Source anchors.

Notebook scoping (core model):
- The primary workspace scope is the active **Notebook/Project**.
- When a Notebook is active, the Library shows Sources *scoped to that Notebook* by default (with an explicit way to view “All Sources” only if/when the product design calls for it).
- Deep-links into Sources must preserve the current Notebook scope so that reading/notes/assistant context stays coherent.

Responsive behavior (minimum):
- On narrow widths, panes may collapse into navigable surfaces (e.g., Source panel becomes a drawer; Assistant becomes a sheet). The information architecture must remain tri-pane in intent even if not simultaneously visible.

## 2. Component Interface

### Props
The component is a top-level route and does not accept external props.
```typescript
interface LibraryProps {}
```

### State Management
| State Variable | Type | Description |
| :--- | :--- | :--- |
| `items` | `Array<UnifiedRecording>` (current) → `Array<Source>` (target) | List of all library items (captures/sources). |
| `loading` | `boolean` | Global loading state for fetching library items. |
| `locationFilter` | `'all' | 'device-only' | 'local-only'` | Filter by storage location. |
| `categoryFilter` | `string` | Filter by recording category (meeting, note, etc). |
| `qualityFilter` | `string` | Filter by AI-assigned quality rating. |
| `statusFilter` | `string` | Filter by processing status (transcribed, pending). |
| `searchQuery` | `string` | User input for searching filename/title/subject. |
| `compactView` | `boolean` | Toggles between List (compact) and Card views. Persisted in `UIStore`. |
| `expandedTranscripts` | `Set<string>` | Tracks IDs of expanded transcript accordions. |
| `bulkProcessing` | `boolean` | Indicates if a bulk operation is in progress. |

### Data Flow & Dependencies
-   **`useUnifiedRecordings`**: Hook that aggregates data from `DeviceService` and `DatabaseService`.
-   **`useUIStore`**: Persists view preferences (`compactView`) and audio playback state.
-   **`useAudioControls`**: Centralized controller for the global audio player.
-   **`electronAPI`**:
    -   `transcripts.getByRecordingIds`: Batch fetches transcript data.
    -   `meetings.getByIds`: Batch fetches calendar meeting metadata.
    -   `downloadService`: Queues device files for download.

## 2.1 Target evolution: from `UnifiedRecording` to `Source`

The current UI uses `UnifiedRecording` as its top-level entity. The redesign introduces a `Source` model (audio/pdf/markdown/web clips) that supports stable citation anchors.

Minimum fields required for the Library UI:

```typescript
type SourceType = 'audio' | 'pdf' | 'markdown' | 'image' | 'web_clip';

interface Source {
    id: string;
    type: SourceType;
    title: string;
    capturedAt: string; // ISO
    parentId?: string;
    processingStatus: 'none' | 'queued' | 'processing' | 'ready' | 'error';
}

type SourceAnchor =
    | { kind: 'audio_time'; startMs: number; endMs: number }
    | { kind: 'text_range'; startOffset: number; endOffset: number }
    | { kind: 'page_range'; startPage: number; endPage: number };
```

## 3. Behavior & Interactions

### 3.1 Data Loading & Enrichment
-   **Initial Load**: Fetches the Library item list immediately on mount.
-   **Enrichment**:
    -   **Trigger**: When the items list changes (specifically local IDs).
    -   **Action**: Batched async fetch of `transcripts` and `meetings` for visible/local items.
    -   **Optimization**: Uses `enrichmentKey` memoization to prevent redundant fetches.

### 3.2 Filtering & Search
-   **Logic**: Client-side filtering on the items array.
-   **Performance**: Memoized `filteredItems` to prevent re-calculation on render.
-   **Criteria**:
    -   Location (Device/Local)
    -   Category (Meeting/Note/etc)
    -   Quality (Valuable/Archived)
    -   Status (Processing/Ready)
    -   Search (Filename, Title, Meeting Subject)

### 3.3 Virtualization
-   **Library**: `@tanstack/react-virtual`
-   **Row Height**:
    -   **Compact**: Fixed 52px.
    -   **Card**: Dynamic based on content (Base 120px + Player + Meeting + Transcript).
-   **Overscan**: 5 items for smooth scrolling.

### 3.4 Audio Playback
-   **Interaction**: Click Play button on a card/row.
-   **Logic**:
    -   If `localPath` exists: Plays via `AudioPlayer`.
    -   If `device-only`: Prompt/Trigger download first.
    -   State: Only one audio file plays at a time (managed by `currentlyPlayingId`).

### 3.5 Bulk Actions
-   **Download All**: queues all `device-only` items in the current filter view.
-   **Process All**: queues all `local-only` items without transcripts for AI processing.

## 4. Design & Styling

### Design Tokens
-   **Colors**: Uses `shadcn/ui` theme variables (`bg-background`, `text-muted-foreground`, `border-input`).
-   **Icons**: `lucide-react` for all iconography.

### Typography (Tailwind conventions)

Library typography should remain consistent with the existing app defaults and shadcn components.

- Page title: `text-2xl font-bold`
- Section labels / metadata: `text-xs text-muted-foreground`
- Row title: `text-sm font-medium text-foreground`
- Secondary text: `text-xs text-muted-foreground`

### Iconography (existing)

Use `lucide-react` icons already present in the current implementation:

- Navigation/affordances: `Search`, `Filter`, `LayoutGrid`, `List`, `ChevronDown`, `ChevronUp`
- Item status: `Cloud` (device-only), `HardDrive` (local), `Check` (synced)
- Actions: `Play`, `Download`, `Trash2`, `RefreshCw`, `Plus`, `X`
- Errors/attention: `AlertCircle`, `Zap`

### Status indicators (token-based)

Do not hard-code colors. Status should be represented by:

- Icon + label (always)
- Optional badge using shadcn `Badge` variants or token-based classes
    - e.g. neutral: `bg-muted text-muted-foreground`
    - attention: `bg-destructive/10 text-destructive` (token-based)

### 4.0 Vision alignment (do not mirror the current UI)

This spec defines the **target** Library experience for the Knowledge App vision. Do not copy/preserve UI decisions just because they exist today.

Guardrails:

- Library is the Sources surface: fast triage + reliable retrieval + evidence-first reading.
- Derived content (summaries, actionables, entities) is always clearly separated from Source evidence and traceable back to anchors.
- Styling remains token-based (shadcn/Tailwind theme primitives). Avoid hard-coded palette decisions.
- Interactions must scale to large libraries: virtualization, incremental loading, predictable keyboard behavior.

---

## 4.1 Wireframes (Desktop / Tablet / Mobile)

These wireframes describe layout and interaction zones. They intentionally reference **components and tokens** rather than fixed pixels/colors.

### Desktop (>= 1024px)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│ App Shell                                                                    │
│  ┌────────────── Sidebar ──────────────┐  ┌──────────── Library ───────────┐ │
│  │  Library (active)                   │  │ Header                         │ │
│  │  Explore                            │  │  Title: Knowledge Library      │ │
│  │  Assistant                          │  │  [Refresh]  [Import?]          │ │
│  │  ...                                │  │                                │ │
│  └─────────────────────────────────────┘  │ FilterToolbar                  │ │
│                                           │  [Search………………] [Filters▼]     │ │
│                                           │  Chips: Location/Status/...     │ │
│                                           │  View: [Compact] [List] [Grid]  │ │
│                                           ├────────────────────────────────┤ │
│                                           │ Virtualized Results             │ │
│                                           │  Row/Card (hover -> actions)    │ │
│                                           │   [StatusIcon] Title  Meta      │ │
│                                           │   [Play] [Download] [Delete]    │ │
│                                           └────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────┘

Detail surface (overlay):
┌────────────────────────────── Source Detail Drawer ──────────────────────────┐
│ Header: Title + StatusBadge                                [Close]          │
│ Player: waveform/controls (sticky within drawer)                            │
│ Tabs: Transcript | Summary | Notes                                           │
│ Transcript: clickable anchors (time ranges)                                 │
│ Actions: Transcribe/Process, Export, Link to meeting                         │
└──────────────────────────────────────────────────────────────────────────────┘
```

### Tablet (768px-1023px)

- Sidebar collapses to icon rail or hamburger in header.
- FilterToolbar wraps to two rows:
    - Row 1: Search + Filters
    - Row 2: chips + view toggle
- Detail remains a drawer, but can become a full-height sheet.

### Mobile (< 768px)

- Single-column list.
- Filters open in a `Sheet`.
- Detail view becomes full-screen (route or sheet) with a back action.

---

## 4.2 High-fidelity mockup spec (token + component driven)

This section defines “hi-fi” UI expectations without introducing new colors/fonts.

### Layout primitives

- Page uses shadcn `Card` for grouped surfaces.
- Inputs use shadcn `Input` and `Button`.
- Bulk mode uses a distinct surface (e.g., `bg-muted/50` container) with clear count + actions.

### Library header

- Title left-aligned; primary actions right-aligned.
- Header should not jump during background refresh (keep height stable).

### Filter toolbar

- Search input: left, full width until it reaches a comfortable max width.
- Filters: either dropdowns or a single “Filters” button that opens a `Sheet` (mobile-first).
- View mode: icon buttons (`List`, `LayoutGrid`) and optional “Compact” toggle.

### Result items

**Compact row** (fixed height target: 52px)

- Left: selection checkbox (bulk mode)
- Status icon + tooltip
- Title (truncate)
- Meta (duration, date, meeting subject)
- Right: action cluster appears on hover/focus

Row interaction expectations (vision-driven):

- Single click selects/focuses row.
- Primary action opens detail (drawer/sheet/route).
- Play is an explicit button (never implicit on single click).
- Selection supports bulk actions and works without hover.

**Card/grid**

- Title + status
- Mini player affordance
- Transcript snippet (collapsed by default)

---

## 4.3 Interaction patterns & user flows

### Flow A: Find and play a local capture
1. User opens `/library`.
2. Uses search and/or filters.
3. Clicks Play on an item.
4. Global audio state updates (only one plays at a time).

### Flow B: Device-only capture -> download -> play
1. User sees item status “device-only”.
2. Clicks Download.
3. Item shows downloading/progress state; play becomes available when local.

### Flow C: Process/transcribe (single)
1. User opens detail drawer.
2. Clicks Process/Transcribe.
3. Item status updates: queued -> processing -> completed/error.
4. Transcript/summary surfaces update when completed.

### Flow D: Bulk operations
1. User selects multiple items.
2. BulkActionsBar appears with count.
3. User chooses “Download” or “Process”.
4. Progress shown globally and per-item.

---

## 4.4 Component state model

### Page-level states

- `loading`: skeleton/placeholder list; controls disabled appropriately.
- `error`: error banner with Retry.
- `empty`: “No Knowledge Captured” CTA.
- `noResults`: “No Matching Captures” hint to clear filters.

### Item-level states

| State | Visual | Allowed actions |
| :--- | :--- | :--- |
| `device-only` | Cloud icon + label | Download, (optional) Delete-from-device |
| `local-only` | HardDrive icon + label | Play, Process, Delete |
| `synced` | Check icon + label | Play, Process, Delete |
| `downloading` | Progress indicator | Cancel (optional), disable Play |
| `processing` | Spinner/badge | Disable destructive actions, allow view transcript placeholder |
| `error` | Alert icon + error badge | Retry processing/download |
| `playing` | Play toggled + subtle highlight using tokens | Pause/Stop |

---

## 4.5 Responsive considerations

- Virtualized list must remain the scroll container on all breakpoints.
- Hover-only affordances must have keyboard/focus equivalents.
- Mobile uses `Sheet`/full-screen detail to avoid cramped drawers.

## 5. Accessibility (A11y)

### ARIA Roles
-   **List Container**: `role="feed"` or `role="list"` for the virtualizer container.
-   **List Item**: `role="article"` or `role="listitem"`.
-   **Interactive Elements**: All buttons must have `aria-label` or `title`.

### Detail surface (drawer/sheet) accessibility

- Must implement focus trapping while open.
- Must close on `Esc`.
- Use appropriate dialog semantics (`role="dialog"`, `aria-modal="true"`) when rendered as an overlay.

### Keyboard Navigation
-   **Focus**: Filters and List items should be focusable via `Tab`.
-   **Shortcuts**:
   **Shortcuts** (recommended baseline):
    -   `Enter`: Open focused item detail.
    -   `Space`: Toggle selection.
    -   `Arrow Up/Down`: Move focus through the list.
    -   `Shift+Arrow Up/Down`: Extend selection range (bulk mode).
    -   `Esc`: Clear selection / close detail surface (if open).

## 5.1 Import interactions (vision)

- Drag & drop import: when files are dragged over the list, show a token-based overlay affordance and accept drop to import.
- Loading: prefer skeleton rows/cards over a single spinner for the main list, to keep layout stable.

## 6. Error Handling

| Scenario | UX Result | Recovery |
| :--- | :--- | :--- |
| **Load Failed** | Show error banner with retry button. | Manual retry via "Refresh" button. |
| **Download Failed** | Toast notification error. | Retry button on item. |
| **Enrichment Failed** | Silently log error; Show basic card without details. | Auto-retry on next refresh. |
| **Device Disconnected** | Disable "Download" and "Device-delete" actions. | Visual indicator in header. |

## 7. Testing Requirements

### Unit Tests
-   **Filtering**: Verify filter logic correctly excludes items based on all filter types.
-   **Formatting**: Test `formatBytes`, `formatDuration` helpers.

### Integration Tests
-   **Data Loading**: Mock `useUnifiedRecordings` and verify list renders.
-   **Enrichment**: Verify `electronAPI` calls are triggered with correct IDs.
-   **Empty States**: Verify "No Knowledge Captured" vs "No Matching Captures" states.

### Performance Benchmarks
-   **Render Time**: < 100ms for list mount.
-   **Scroll FPS**: Maintains 60fps with 1000+ items (via virtualization).
